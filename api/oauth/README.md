# Получение ключа доступа

[![PkgGoDev][doc-badge]][doc]
[![VK][dev-badge]](https://vk.com/dev/access_token)

Для работы со всеми методами API Вам необходимо передавать в запросе
**access_token** — специальный ключ доступа. Он представляет собой строку из
латинских букв и цифр и может соответствовать отдельному пользователю,
сообществу или самому Вашему приложению.

ВКонтакте поддерживает несколько способов получения ключа доступа по OAuth 2.0:

1. **Implicit flow** — требует встраивания браузера в ваше приложение.
Ключ возвращается на устройство пользователя, где был открыт диалог авторизации
(в виде дополнительного параметра URL). Такой ключ может быть использован
только для запросов непосредственно с устройства пользователя.

2. **Authorization code flow** — двухэтапный вариант с дополнительной
аутентификацией Вашего сервера. Ключ доступа возвращается непосредственно на
сервер и может быть использован, например, для автоматизированных запросов.

- TODO: прямая авторизация
- TODO: посмотреть получение токена как в vk-miniapps-deploy

## Ключ доступа пользователя

### Implicit flow

[![VK][dev-badge]](https://vk.com/dev/implicit_flow_user)

Используйте Implicit Flow для вызова методов API ВКонтакте непосредственно с
устройства пользователя.

#### Сгенерируйте адрес

```go
u := oauth.ImplicitFlowUser(oauth.UserParams{
    ClientID: 123456,
    Scope:    123,
})
```

RedirectURI по умолчанию `https://oauth.vk.com/blank.html`

#### Разрешение прав доступа

Необходимо перенаправить **встроенный браузер** по адресу сгенерированному на
предыдущем шаге.

Рекомендуется проверять, что страница вернула код 200. Если код отличается, а
`content-type` содержит JSON, необходимо распарсить этот JSON в ошибку:

```go
var errOAuth oauth.Error
err = json.Unmarshal(data, &errOAuth)
```

Если пользователь не авторизован ВКонтакте в используемом браузере, то в
диалоговом окне ему будет предложено ввести свой логин и пароль.

После успешного входа на сайт пользователю будет предложено авторизовать
приложение, разрешив доступ к необходимым настройкам, запрошенным при помощи
параметра scope.

#### Получение access_token

После успешной авторизации приложения браузер пользователя будет перенаправлен
по адресу redirect_uri, указанному при открытии диалога авторизации. При этом
ключ доступа к API access_token и другие параметры будут переданы в
URL-фрагменте ссылки.

```go
t, err := oauth.NewUserTokenFromURL(u)
if err != nil {
    // Смотри обработку ошибок
}

fmt.Println(
    "Токен %s для id%d действует %d секунд",
    t.AccessToken,
    t.UserID,
    t.ExpiresIn,
)
```

`ExpiresIn` содержит 0, если токен бессрочный
(при использовании scope=offline).

### Authorization code flow

[![VK][dev-badge]](https://vk.com/dev/authcode_flow_user)

Используйте Authorization Code Flow для вызова методов API ВКонтакте с
серверной части Вашего приложения. Ключ доступа, полученный таким способом, не
привязан к IP-адресу, но набор прав, которые может получить приложение,
ограничен из соображений безопасности.

#### Сгенерируйте адрес

```go
acf := NewAuthCodeFlowUser(oauth.UserParams{
    ClientID:    123456,
    RedirectURI: "https://example.com/callback",
    Scope:       123,
}, clientSecret)
u := acf.URL().String()
```

Необходимо перенаправить браузер пользователя по сгенерированному адресу.

Если пользователь не вошел на сайт, то в диалоговом окне ему будет предложено
ввести свой логин и пароль.

#### Разрешение прав доступа

После успешного входа на сайт пользователю будет предложено авторизовать
приложение, разрешив доступ к необходимым настройкам, запрошенным при помощи
параметра scope.

Обратите внимание, что некоторые права доступа пользователя из списка
(например, messages) могут быть запрошены только Standalone-приложением — что
означает необходимость использования Implicit Flow для запроса таких прав.

#### Получение access_token

После успешной авторизации приложения браузер пользователя будет перенаправлен
по адресу redirect_uri, указанному при открытии диалога авторизации. При этом
код для получения ключа доступа `code` будет передан как GET-параметр.

```go
func callback(w http.ResponseWriter, req *http.Request) {
    t, err := acf.Token(req.URL)
    if err != nil {
        // Смотри обработку ошибок
    }

    fmt.Println(
        "Токен %s для id%d действует %d секунд",
        t.AccessToken,
        t.UserID,
        t.ExpiresIn,
    )
}
```

`acf.Token(req.URL)` выполнит запрос с вашего сервера, чтобы получить ключ
доступа.

### Direct Authorization

[![VK][dev-badge]](https://vk.com/dev/auth_direct)

> **Внимание! Доступ к этому типу авторизации может быть получен только после**
> **предварительного согласования с администрацией ВКонтакте.**
>
> Для подачи заявки на получение доступа Вам необходимо обратиться в службу
> поддержки, указав ID Вашего приложения.
>
> В настоящий момент эта возможность предоставляется только для платформ, не
> поддерживающих стандартную авторизацию. В заявке необходимо кратко описать
> функционал приложения.

- TODO: разработать

## Ключ доступа сообщества

### Implicit flow

[![VK][dev-badge]](https://vk.com/dev/implicit_flow_group)

- TODO: разработать

### Authorization code flow

[![VK][dev-badge]](https://vk.com/dev/authcode_flow_group)

- TODO: разработать

## Сервисный ключ доступа

Сервисный ключ нужен для запросов, которые не требуют авторизации пользователя
или сообщества. Это такие методы, как
[secure.sendNotification][secure.sendNotification]для отправки уведомлений от
приложения, или [secure.addAppEvent][secure.addAppEvent] для добавления
информации о достижениях, а также, начиная с апреля 2017 года, открытые методы,
например, [users.get][users.get].

Получить сервисный ключ доступа можно в [настройках][appsmanage] Вашего
приложения. Ключ не привязан к IP-адресу при использовании с открытыми
методами, срок его действия не ограничен. Если ключ был скомпрометирован, Вы
можете сгенерировать новый ключ, при этом старый будет аннулирован.

Сервисный ключ доступа идентифицирует Ваше приложение. Все запросы к API,
совершённые с использованием Вашего ключа доступа, будут считаться совершёнными
от имени Вашего приложения. Сервисный ключ доступа можно использовать только
для запросов с серверной стороны приложения, его нельзя передавать и хранить
на клиенте.

- TODO: Проверить следующее:

Для запросов к методам **secure** сервисный ключ привязан к IP-адресу, с
которого был сгенерирован

[doc-badge]: https://pkg.go.dev/badge/github.com/SevereCloud/vksdk/api/oauth
[doc]: https://pkg.go.dev/github.com/SevereCloud/vksdk/api/oauth
[dev-badge]: https://img.shields.io/badge/developers-%234a76a8.svg?logo=VK&logoColor=white
[users.get]: https://vk.com/dev/users.get
[secure.addAppEvent]: https://vk.com/dev/secure.addAppEvent
[secure.sendNotification]: https://vk.com/dev/secure.sendNotification
[appsmanage]: https://vk.com/apps?act=manage
